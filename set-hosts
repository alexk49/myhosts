#!/usr/bin/env bash

# wrapper script to manage two different host files
# based on stevenblack's hosts repo

# after updating hosts, you may need to flush dns cache,
# by restarting the NetworkManager, on ubuntu run:
# sudo systemctl restart NetworkManager

set -e
set -u
set -o pipefail

# steven black's host repo and scripts
SB_HOSTS_DIR="$HOME/.local/share/stevenblack-hosts"
# created host files and custom host files:
MY_HOSTS_DIR="$HOME/.local/share/myhosts"

usage () {
    cat << _EOF_

-h | --help
see this help message

-w | --work
set work hosts file

-d | --default
set default all hosts file

-g | --get
clone steven black hosts repo and generate hosts file

-s | --setup
clone steven black hosts repo and generate both hosts files

-u | --update
update existing repo and all host files

_EOF_
}

clone_sb_repo () {
    echo "fetching hosts files"
        
    SB_HOSTS_DIR="$1"

    if [[ ! -e "$SB_HOSTS_DIR" ]]; then 
        echo "cloning repo into $SB_HOSTS_DIR"
        git clone --depth 1 https://github.com/StevenBlack/hosts.git "$SB_HOSTS_DIR"
    fi
}

update_repo () {
    SB_HOSTS_DIR="$1"

    clone_sb_repo "$SB_HOSTS_DIR"

    cd "$SB_HOSTS_DIR" || exit 1

    # rest some of the autogenerated files
    git restore data
    git restore extensions
    git pull

}

set_activation_path () {
    if [[ -f "$venv/bin/activate" ]]; then
        ACTIVATE_PATH="$venv/bin/activate"
    else
        echo "Error: No venv activation script found in $venv" >&2
        exit 1
    fi

    source "$ACTIVATE_PATH" || exit 1
}

set_up_venv () {
    venv=.venv

    if command -v python3 >/dev/null 2>&1; then
        PYTHON=python3
    elif command -v python >/dev/null 2>&1; then
        PYTHON=python
    else
        echo "Error: Python is not installed or not in PATH." >&2
        exit 1
    fi

    echo "Using python executable: $PYTHON"

    if [[ -d "$venv" ]]; then
        echo "Virtual environment '$venv' already exists."
        set_activation_path
        return
    else
        echo "Creating virtual environment: $venv"
        "$PYTHON" -m venv "$venv" || { echo "Failed to create venv."; exit 1; }
    fi
    
    set_activation_path

    echo "installing requirements"
    pip install --upgrade pip >/dev/null 2>&1
    pip install -r requirements.txt
}

generate_hosts_files () {
    my_hosts_file="$1"
    echo "generating hosts files"

    if [[ "$my_hosts_file" == *.work ]]; then
        generate_work_hosts_file        
    else
        generate_main_hosts_file
    fi
}

generate_work_hosts_file () {
    #python updateHostsFile.py --output ~/.local/share/myhosts --extensions fakenews gambling porn social --nogendata --auto
    python updateHostsFile.py --output "$MY_HOSTS_DIR/myhosts" --extensions fakenews gambling porn --nogendata --auto
    cp -v "$MY_HOSTS_DIR/hosts" "$MY_HOSTS_DIR/hosts.work" || exit 1

    if [[ -e "$MY_HOSTS_DIR/myhosts.work" ]]; then
        echo "adding custom hosts local"
        cat "$MY_HOSTS_DIR/myhosts" >> "$MY_HOSTS_DIR/hosts.work"
        echo "adding custom work hosts"
        cat "$MY_HOSTS_DIR/myhosts.work" >> "$MY_HOSTS_DIR/hosts.work"
    fi
}

generate_main_hosts_file () {
    python updateHostsFile.py --output "$MY_HOSTS_DIR/myhosts" --extensions fakenews gambling porn --nogendata --auto
    cp -v "$MY_HOSTS_DIR/hosts" "$MY_HOSTS_DIR/hosts.main" || exit 1

    if [[ -e "$MY_HOSTS_DIR/myhosts" ]]; then
        echo "adding custom hosts"
        cat "$MY_HOSTS_DIR/myhosts" >> "$MY_HOSTS_DIR/hosts.main"
    fi
}

run_setup () {
    clone_sb_repo "$SB_HOSTS_DIR"

    cd "$SB_HOSTS_DIR" || exit 1

    set_up_venv
    
    generate_work_hosts_file

    generate_main_hosts_file
}

main() {
    if [[ $# -eq 0 ]]; then
        echo "No arguments supplied"
        usage
        exit 1
    fi

    if [[ ! -e "$MY_HOSTS_DIR/myhosts" ]]; then
        mkdir -p "$MY_HOSTS_DIR/myhosts"
    fi

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            -w|--work)
                my_hosts_file="$MY_HOSTS_DIR/hosts.work"
                ;;
            -d|--default)
                my_hosts_file="$MY_HOSTS_DIR/myhosts/hosts.main"
                ;;
            -g|--get)
                get_hosts=true
                ;;
            -s|--setup)
                run_setup
                exit 0
                ;;
            -u|--update)
                update_repo "$SB_HOSTS_DIR"
                set_up_venv
                generate_work_hosts_file        
                generate_main_hosts_file
                exit 0
                ;;
        esac
        shift
    done

    if [[ ! -e "$my_hosts_file" && -z "${get_hosts+x}" ]]; then
        echo "hosts file does not exist: $my_hosts_file - run with --get|-g to clone repo and create hosts files, or run with --setup|-s to re-generate all files"
        exit 1
    elif [[ ! -e "$my_hosts_file" && "$get_hosts" = true ]]; then
        clone_sb_repo "$SB_HOSTS_DIR"

        cd "$SB_HOSTS_DIR" || exit 1

        set_up_venv

        generate_hosts_files "$my_hosts_file"
    fi

    echo "copying hosts file: $my_hosts_file to system hosts file: /etc/hosts"
    sudo cp -v "$my_hosts_file" /etc/hosts --backup --suffix=.bak
    echo "restarting network manager to flush dns cache"
    sudo systemctl restart NetworkManager
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
