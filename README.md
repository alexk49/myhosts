# myhosts

Wrapper script for [Steven Black Hosts](https://github.com/StevenBlack/hosts) to manage two different hosts files on a timer. This allows you to:

- block general ads/malware constantly
- block distracting sites during work hours only.
- Supports cron, autostart, or systemd timers

This has been tested on Ubuntu 24.04.3 LTS only but linux distributions with /etc/hosts should work but the autostart/timer settings maybe different.

## Install

For general usage, the script will clone, set up and manage the [Steven Black Hosts](https://github.com/StevenBlack/hosts) in .local/share/stevenblack-hosts.

If you want to set up timers for the script then a different process is outlined below under timers.

Download the file or clone the repo:

```
# download script
wget https://raw.githubusercontent.com/alexk49/myhosts/refs/heads/main/myhosts
# set executable permissions
chmod +x myhosts
```

```
# download config if wanted
mkdir -p ~/.local/share/myhosts
wget https://raw.githubusercontent.com/alexk49/myhosts/refs/heads/main/myhosts.conf.example -O ~/.local/share/myhosts/myhosts.conf
```

Or clone the repo:

```
mkdir -p ~/.local/share/myhosts
cd ~/.local/share
git clone https://github.com/alexk49/myhosts.git
```

## Custom host files

The bulk of the host files are created by the Steven Black script but you can have your own custom files as well. These are kept in:

```
# custom default hosts file used by default and work
~/.local/share/myhosts/myhosts.main

# custom work only hosts file
~/.local/share/myhosts/myhosts.work
```

The custom host files should follow the same rules outlined in the [Steven Black hosts README](https://github.com/StevenBlack/hosts), so the lines should generally look like:

```
0.0.0.0 site-to-block

# e.g block reddit:
0.0.0.0 reddit.com
```

The generated hosts files will be created in the same directory:

```
# default hosts file
~/.local/share/myhosts/hosts.main
# work hosts file
~/.local/share/myhosts/hosts.work
```

Whenever you run the script to change hosts the in use file will be set in:

```
~/.local/share/myhosts/hosts
```

Which is then copied across as the main hosts file - which is backed up everytime it is changed.

```
# main system hosts file
/etc/hosts
# back up version
/etc/hosts.bak
```

## Setup

To clone the Steven Black Hosts repo and generate both a default and work hosts file, run:

```
myhosts --setup
```

This will create the following files in ~/.local/share/myhosts:

```
hosts  hosts.main  hosts.work
```

The hosts file in this directory is just the output of the updateHostsFile.py script.

Before modifying your system hosts file, back it up:

```
sudo cp /etc/hosts /etc/hosts.org.bak
```

If the original system hosts has mappings you'd like to keep then do:

```
sudo cp /etc/hosts ~/.local/share/myhosts/myhosts.main

# or if you've already started making a myhosts file:
sudo cat /etc/hosts >> ~/.local/share/myhosts/myhosts.main
```

You can then further customise your myhosts.main file - that is used for both the work and default hosts file - as needed.

# Usage

The script requires sudo permissions to make changes to the system hosts file - and, if the flag is passed, to restart the Network Manager to flush the DNS cache after changing the system hosts file.

Once the two files have been generated through the set up, you can toggle the hosts file used as the system hosts with:

```
# set main hosts file
myhosts --default

# set work hosts file
myhosts --work
```

If you need to regenerate a single host file - for example after changing your custom hosts - you can run:

```
# regenerate main hosts file
myhosts --default --get

# regenerate work hosts file
myhosts --work --get
```

This will make the hosts file again from your current version of the Steven Black repository and re-add your custom hosts.

To completely update the Steven Black hosts repository and both hosts files run:

```
myhosts --update
```

You will want to do this now and again to get the updated block lists.

## Timers

Once you have two hosts files you are happy with you might want to make different ones get used at different times of day, for example using the .work hosts file during work hours and the main hosts file the rest of the time.

Setting up a timer comes with a security consideration for what you would prefer. You can use:

- User mode: simple, suitable for single-user machines
- System user mode: host files generated by locked-down user, and only applied by root helper

Both options are detailed below. But either will require some configuration and set up.

### Configuration

Certain values can be updated with either the config file or with cli args - and custom myhosts files can be added. The config and custom files should go in the myhosts directory.

The default location for the myhosts directory - where the host files will be generated and updated is:

```
~/.local/share/myhosts
```

and the default location for the copied Steven Black repo is:

```
~/.local/share/stevenblack-hosts/
```

These can be overriden at run time by defining the environment variables before running:

```
export MY_HOSTS_DIR=/some/custom/path
export SB_HOSTS_DIR=/some/custom/path 
```

This is useful if you want to set the script to set up the system user timers, which means the custom host files can only be edited or made by root.

If doing this then the setup assumes you use the path:

```
/var/lib/myhosts
```

to keep your custom host files and config file in.

The default work hours are 09:00 to 17:00. To update these, you can either use a .config file to specify the times or override via cli args.

You will need to specify the variables in the format:

```
# Enable weekday-only work mode
WORK_DAYS=1            # 1 = Mon–Fri only, 0 = every day

# Work hours (24h format)
WORK_START=08:30
WORK_END=16:30
```

See the myhosts.conf.example for more or for a quick start.

You can also set holidays from the work block list with a holidays file called holidays.conf. This is useful if you just want a break or if share a computer with someone else who doesn't need their internet access locked down to do anything! See holidays.conf.example for details.

When happy you can copy the config to your myhosts dir:

```
# user mode
cp myhosts.conf.example ~/.local/share/myhosts/myhosts.conf

# system user mode
sudo cp myhosts.conf.example /var/lib/myhosts/myhosts.conf
```

And - if using it - your holidays file as well:

```
# user mode
cp holidays.conf.example ~/.local/share/myhosts/holidays.conf

# system user mode
sudo cp holidays.conf.example /var/lib/myhosts/holidays.conf
```

Alternataively, you can use cli args. With cli args but you must put the variable args first, before the task flag like:

```
myhosts --work-start 08:30 --work-end 16:30 --auto
```

## User timer set up

The below is the set up you can follow to keep the custom host files in the default user directory:

```
~/.local/share/myhosts
```

You can set up cronjobs like the below:

```
# open user cron
crontab -e 
```

Set up cronjobs like the below, updating "you" to your actual username:

```
SHELL=/bin/bash

# start of work
30 8 * * 1-5 /home/you/.local/share/myhosts --auto >> /home/you/.local/share/myhosts/myhosts.log 2>&1

# End of work hours
30 16 * * 1-5 /home/you/.local/share/myhosts --auto >> /home/you/.local/share/myhosts/myhosts.log 2>&1

# update host files repo once a week
30 9 * * 1 /home/you/.local/share/myhosts --update >> /home/you/.local/share/myhosts/myhosts.log 2>&1

# on system reboot
# don't use this one if you set up the autostart below
@reboot /home/you/.local/share/myhosts --auto >> /home/you/.local/share/myhosts/myhosts.log 2>&1
```

An additional option is to set myhosts to run as an autostart script. This should replace the cron reboot option in the above - and is preferable as then it will update on every login instead of just full restart.

One line of the autostart config will depend on your desktop environment.

For kde:

```
tee ~/.config/autostart/myhosts.desktop >/dev/null <<EOF
[Desktop Entry]
Type=Application
Exec=/bin/bash -c "/home/$USER/.local/share/myhosts --auto >> /home/$USER/.local/share/myhosts/myhosts.log 2>&1"
Hidden=false
NoDisplay=false
X-KDE-AutostartScript=true
Name=myhosts
Comment=Copy hosts file at login
Version=1.0
EOF
```

For lxqt:

```
tee ~/.config/autostart/myhosts.desktop >/dev/null <<EOF
[Desktop Entry]
Type=Application
Exec=/bin/bash -c "/home/$USER/.local/share/myhosts --auto >> /home/$USER/.local/share/myhosts/myhosts.log 2>&1"
Hidden=false
NoDisplay=false
X-LXQt-Autostart-enabled=true
Name=myhosts
Comment=Copy hosts file at login
Version=1.0'
EOF
```

This will make the script run upon every login.

If running this way then you will either want to have passwordless sudo set up for your user or set passwordless sudo just for this script by adding it as visudo entry.

Open visudo entry:

```
sudo visudo -f /etc/sudoers.d/myhosts
```

Copy into file (but update 'you' to your actual username):

```
# Allow user to copy any hosts file from .local/share/myshare to /etc/hosts without password
you ALL=(root) NOPASSWD: /usr/bin/cp -v /home/you/.local/share/myhosts/hosts.* /etc/hosts --backup --suffix=.bak
```

This allows just this specific command that is used in the myhosts script to update the system hosts file, to run without sudo password when running as the specified user.

This is probably the simplest way to set the hosts file changes on a schedule and is arguably fine for a single user on a non-shared device.

But, if you don't like the idea of a user owned file being copied across to the system hosts file, without password entry, then you may want to set up a more robust system user to handle the scheduling and updates.

## System user

Setting up a dedicated system user to make the host files will keep the host files in a dedicated protected directory and mean the actual host file update - to /etc/hosts - can then be done in a separate root only helper script.

This means a system user owns and protects the actual host files that are generated, and only root (or user with sudo permissions) can update the system host file.

First, make a non-login system user:

```
sudo useradd \
  --system \
  --home /var/lib/myhosts \
  --shell /usr/sbin/nologin \
  myhosts
```

Then create its working directory and set permissions:

```
sudo mkdir -p /var/lib/myhosts
# set myhosts as owner
sudo chown -R myhosts:myhosts /var/lib/myhosts
# set read, write, execute permissions for myhosts user only
sudo chmod 750 /var/lib/myhosts
```

Host files will be made in /var/lib/myhosts and custom files will also be stored there,

Install the script into the myhosts dir:

```
# cd to wherever you have first downloaded the script

# add myhosts script to /usr/local/libexec and set permissions
sudo mkdir -p /usr/local/libexec
sudo install -m 755 myhosts /usr/local/libexec/myhosts
```

Configure environment variables for the system user:

```
sudo tee /var/lib/myhosts/myhosts.env >/dev/null <<EOF
MY_HOSTS_DIR=/var/lib/myhosts
SB_HOSTS_DIR=/var/lib/myhosts/stevenblack-hosts
APPLY_MODE=external
EOF
```

If you haven't already it is best to set up your config and custom myhosts files now before you run the setup - see configuration above for more details.

Make sure to place custom myhosts.main and myhosts.work into the system location:

```
sudo cp myhosts.main /var/lib/myhosts/myhosts.main
sudo cp myhosts.work /var/lib/myhosts/myhosts.work
```

And set up your config in there too.

```
sudo cp myhosts.conf /var/lib/myhosts/myhosts.conf
```

And copy holidays.conf file - if you have one:

```
sudo cp holidays.conf /var/lib/myhosts/holidays.conf
```

Run setup as myhosts user:

```
sudo -u myhosts env $(sudo cat /var/lib/myhosts/myhosts.env | xargs) \
  /usr/local/libexec/myhosts --setup
```

This will clone the Steven Black Repo, create a venv for running the host files script and generate the hosts.main and hosts.work files.

Download the myhosts-apply helper script, if you haven't just cloned the repo:

```
wget https://raw.githubusercontent.com/alexk49/myhosts/refs/heads/main/myhosts-apply
```

Restrict usage on the myhosts-apply helper script so that it can only be run by root, and install:

```
sudo install -m 755 myhosts-apply /usr/local/libexec/myhosts-apply
sudo chown root:root /usr/local/libexec/myhosts-apply
sudo chmod 750 /usr/local/libexec/myhosts-apply
```

This script will just read from the fixed paths - expecting host files to be generated in /var/lib/myhosts - and copy the host file to be used.

Then we will want to set up a systemd service and timer which will selecting the host file to be used at a specific time (as myhost system user), applying the host file (as root), and a separate service for updating the host files and host files repo (as myhosts system user).

Set up a systemd service for selecting and applying the host files:

```
sudo tee /etc/systemd/system/myhosts.service >/dev/null <<'EOF'
[Unit]
Description=Generate and apply hosts files

[Service]
Type=oneshot

# generate files as user
User=myhosts
Group=myhosts
EnvironmentFile=/var/lib/myhosts/myhosts.env
ExecStart=/usr/local/libexec/myhosts --auto

# use root to apply update
PermissionsStartOnly=yes
ExecStartPost=/usr/local/libexec/myhosts-apply

NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/lib/myhosts /etc
EOF
```

Set up systemd timer:

```
sudo tee /etc/systemd/system/myhosts.timer > /dev/null << 'EOF'
[Unit]
Description=Periodic hosts update

[Timer]
OnCalendar=Mon..Fri 08:30
OnCalendar=Mon..Fri 16:30
Persistent=true

[Install]
WantedBy=timers.target
EOF
```

Enable the systemd service:

```
sudo systemctl daemon-reload
sudo systemctl enable --now myhosts.timer
```

The host file can now be manually checked and updated with:

```
sudo systemctl start myhosts.service
```

You will want to occassionally update the Steven Black repo blocklists that are used for your host file. You can either do this manually now and again:

```
export MY_HOSTS_DIR=/var/lib/myhosts
sudo -u myhosts /usr/local/libexec/myhosts --update
```

Or create a cronjob for the system user:

```
sudo -u myhosts crontab -e
```

Then add:

```
SHELL=/bin/bash
PATH=/usr/bin:/bin

# Weekly blocklist update (Monday 09:00)
0 9 * * 1 \
  MY_HOSTS_DIR=/var/lib/myhosts \
  SB_HOSTS_DIR=/var/lib/myhosts/stevenblack-hosts \
  MYHOSTS_APPLY_MODE=none \
  /usr/libexec/myhosts --update >> /var/lib/myhosts/myhosts.log 2>&1
```

Alternatively, you can also set up a systemd timer to do update of the files from the Steven Black repo. The example below will do it weekly:

```
sudo tee /etc/systemd/system/myhosts-update.service >/dev/null <<'EOF'
[Unit]
Description=Update and regenerate hosts files

[Service]
Type=oneshot
User=myhosts
Group=myhosts
EnvironmentFile=/var/lib/myhosts/myhosts.env
ExecStart=/usr/local/libexec/myhosts --update

NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/lib/myhosts
EOF
```

And the timer:

```
sudo tee /etc/systemd/system/myhosts-update.timer >/dev/null <<'EOF'
[Unit]
Description=Weekly hosts regeneration

[Timer]
OnCalendar=Sun 03:00
Persistent=true

[Install]
WantedBy=timers.target
EOF
```

Then enable it:

```
sudo systemctl daemon-reload
sudo systemctl enable --now myhosts-update.timer
```

Once set up, this will update the host files from the repo weekly. And apply the main or work host files based on the timers added.

To manually force an update to the host files - say after updating the extension flags or making a manual change to custom myhosts files you would run:

```
# regenerate the files
sudo systemctl start myhosts-update.service
```

```
# apply whichever host file is appropriate now
sudo systemctl start myhosts.service
```

The settings in /etc/systemd/system/myhosts.timer and /var/lib/myhosts/myhosts.conf should match.

So if your .timer is:

```
[Timer]
OnCalendar=Mon..Fri 08:30
OnCalendar=Mon..Fri 16:30
```

Then config file should be:

```
# Enable weekday-only work mode
WORK_DAYS=1            # 1 = Mon–Fri only, 0 = every day

# Work hours (24h format)
WORK_START=08:30
WORK_END=16:30
```

See logs:

```
journalctl -xeu myhosts.service
journalctl -xeu myhosts.timer

journalctl -xeu myhosts-update.service
journalctl -xeu myhosts-update.timer
```

See status:

```
systemctl status myhosts.service
systemctl status myhosts.timer

systemctl status myhosts-update.service
systemctl status myhosts-update.timer
```

## disable / uninstall

If you've set up as a user only, you just need to remove/comment out the cronjobs in:

```
crontab -e
```

And remove the autostart config:

```
rm ~/.config/autostart/myhosts.desktop
```

If you have set up the system user then there is more to remove.

Stop systemd services and timers:

```
sudo systemctl stop myhosts.service \
                    myhosts-update.service
                    myhosts.timer \
                    myhosts-update.timer \
```

Disable timers:

```
sudo systemctl disable --now myhosts.timer
sudo systemctl disable --now myhosts-update.timer
```

Remove all the created myhosts system files:

```
sudo rm \
  /etc/systemd/system/myhosts.timer \
  /etc/systemd/system/myhosts.service \
  /etc/systemd/system/myhosts-update.timer \
  /etc/systemd/system/myhosts-update.service
```

Restart systemctl:

```
sudo systemctl daemon-reload
```

Delete the exectuables:

```
sudo rm /usr/local/libexec/myhosts
sudo rm /usr/local/libexec/myhosts-apply
```

Delete the myhosts user and directory:

```
sudo userdel myhosts
sudo rm -rf /var/lib/myhosts
```

After uninstalling, you may want to manually edit or retore your system hosts file at /etc/hosts.
