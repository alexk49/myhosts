#!/usr/bin/env bash

# wrapper script to manage two different host files
# based on stevenblack's hosts repo

set -euo pipefail

# steven black's host repo and scripts
SB_HOSTS_DIR="$HOME/.local/share/stevenblack-hosts"
# created host files and custom host files:
MY_HOSTS_DIR="$HOME/.local/share/myhosts"

# set default value that can be overriden with config/cli

# regenerate specified host file
get_hosts=false

# if host file is updated also restart network
RESTART_NETWORK=false

# timer settings for auto mode

# Enable weekday-only work mode
WORK_DAYS=1            # 1 = Mon–Fri only, 0 = every day

# Work hours (24h format)
WORK_START=09:00
WORK_END=16:30

# updateHostsFile.py default options

UPDATE_EXTENSIONS="fakenews gambling porn"
UPDATE_FLAGS="--nogendata --auto"

WORK_UPDATE_EXTENSIONS=""
WORK_UPDATE_FLAGS=""

usage () {
    cat << _EOF_

-h | --help
see this help message

-a | --auto
set hosts file based on time

-w | --work
set work hosts file

-d | --default
set default all hosts file

-g | --get
clone steven black hosts repo and generate hosts file

-s | --setup
clone steven black hosts repo and generate both hosts files

-u | --update
update existing repo and all host files

# variables overrides

These need to be passed before the task flag, for example:

./set-hosts --work-start 08:00 --work-end 16:00 --auto

when running --auto the hosts file will be set based on a timer

This will default to work being Mon-Fri 8.30am to 16.30pm

-rn | --restart-network
restart network if host file is updated, to flush DNS cache

-wd | --work-days [1|0]
1 = Mon–Fri only, 0 = every day

-ws | --work-start [work-start-time]
pass work start time in 24h format, e.g 09:00

-we | --work-end)
pass work end time in 24h format, e.g 17:00

-ue | --update-extensions "ext1 ext2"
Main hosts extensions

-uf | --update-flags "--nogendata --auto"
Main hosts flags

-we | --work-extensions "ext1 ext2"
Work hosts extensions

-wf | --work-flags "--nogendata --auto"
Work hosts flags
_EOF_
}


clone_sb_repo () {
    log "fetching hosts files"
        
    SB_HOSTS_DIR="$1"

    if [[ ! -e "$SB_HOSTS_DIR" ]]; then 
        log "cloning repo into $SB_HOSTS_DIR"
        git clone --depth 1 https://github.com/StevenBlack/hosts.git "$SB_HOSTS_DIR"
    fi
}


update_repo () {
    SB_HOSTS_DIR="$1"

    clone_sb_repo "$SB_HOSTS_DIR"

    cd "$SB_HOSTS_DIR" || exit 1

    # reset some of the autogenerated host files
    git restore data
    git restore extensions
    git pull

}


set_activation_path () {
    if [[ -f "$venv/bin/activate" ]]; then
        ACTIVATE_PATH="$venv/bin/activate"
    else
        log "Error: No venv activation script found in $venv" >&2
        exit 1
    fi

    # shellcheck source=/dev/null
    source "$ACTIVATE_PATH" || exit 1
}


set_up_venv () {
    venv=.venv

    if command -v python3 >/dev/null 2>&1; then
        PYTHON=python3
    elif command -v python >/dev/null 2>&1; then
        PYTHON=python
    else
        log "Error: Python is not installed or not in PATH." >&2
        exit 1
    fi

    log "Using python executable: $PYTHON"

    if [[ -d "$venv" ]]; then
        log "Virtual environment '$venv' already exists."
        set_activation_path
        return
    else
        log "Creating virtual environment: $venv"
        "$PYTHON" -m venv "$venv" || { log "Failed to create venv."; exit 1; }
    fi
    
    set_activation_path

    log "installing requirements"
    pip install --upgrade pip >/dev/null 2>&1
    pip install -r requirements.txt
}


generate_hosts_files () {
    my_hosts_file="$1"
    log "generating hosts files"

    if [[ "$my_hosts_file" == *.work ]]; then
        generate_work_hosts_file        
    else
        generate_main_hosts_file
    fi
}


run_update_hosts() {
    local extensions="$1"
    local flags="$2"

    local cmd=(python updateHostsFile.py --output "$MY_HOSTS_DIR")
    if [[ "$extensions" != "none" && -n "$extensions" ]]; then
        read -r -a exts <<< "$extensions"
        cmd+=(--extensions "${exts[@]}")
    fi

    read -r -a extra_flags <<< "$flags"
    cmd+=("${extra_flags[@]}")

    log "Running: ${cmd[*]}"
    "${cmd[@]}"
}


generate_work_hosts_file () {
    run_update_hosts "${WORK_UPDATE_EXTENSIONS:-$UPDATE_EXTENSIONS}" "${WORK_UPDATE_FLAGS:-$UPDATE_FLAGS}"
    cp -v "$MY_HOSTS_DIR/hosts" "$MY_HOSTS_DIR/hosts.work" || exit 1

    if [[ -e "$MY_HOSTS_DIR/myhosts.work" ]]; then
        log "adding custom hosts local"
        cat "$MY_HOSTS_DIR/myhosts" >> "$MY_HOSTS_DIR/hosts.work"
        log "adding custom work hosts"
        cat "$MY_HOSTS_DIR/myhosts.work" >> "$MY_HOSTS_DIR/hosts.work"
    fi
}


generate_main_hosts_file () {
    run_update_hosts "$UPDATE_EXTENSIONS" "$UPDATE_FLAGS"
    cp -v "$MY_HOSTS_DIR/hosts" "$MY_HOSTS_DIR/hosts.main" || exit 1

    if [[ -e "$MY_HOSTS_DIR/myhosts" ]]; then
        log "adding custom hosts"
        cat "$MY_HOSTS_DIR/myhosts" >> "$MY_HOSTS_DIR/hosts.main"
    fi
}


run_setup () {
    clone_sb_repo "$SB_HOSTS_DIR"

    cd "$SB_HOSTS_DIR" || exit 1

    set_up_venv
    
    generate_work_hosts_file

    generate_main_hosts_file
}


time_to_minutes() {
    IFS=: read -r h m <<< "$1"
    echo $((10#$h * 60 + 10#$m))
}


now_minutes() {
    echo $((10#$(date +%H) * 60 + 10#$(date +%M)))
}


is_weekday() {
    local d
    d=$(date +%u)  # 1 = Mon, 7 = Sun
    (( d >= 1 && d <= 5 ))
}

is_holiday() {
    local HOLIDAYS_FILE="$MY_HOSTS_DIR/holidays.conf"

    [[ -f "$HOLIDAYS_FILE" ]] || return 1

    local today
    today=$(date +%F)
    local md
    md=$(date +%m-%d)

    while read -r line; do
        case "$line" in
            "$today"|"$md")
                log "today is holiday, default host file will be used"
                return 0
                ;;
        esac
    done < <(grep -Ev '^\s*(#|$)' "$HOLIDAYS_FILE")

    return 1
}


determine_hosts_file() {
    # determine which host file to use based on time
    NOW=$(now_minutes)
    START=$(time_to_minutes "$WORK_START")
    END=$(time_to_minutes "$WORK_END")

    my_hosts_file="$MY_HOSTS_DIR/hosts.main"

    if (( NOW >= START && NOW < END )); then
        if [[ "${WORK_DAYS:-0}" -eq 1 ]]; then
            if is_weekday && ! is_holiday; then
                my_hosts_file="$MY_HOSTS_DIR/hosts.work"
            fi
        else
            if ! is_holiday; then
                my_hosts_file="$MY_HOSTS_DIR/hosts.work"
            fi
        fi
    fi
    echo "$my_hosts_file"
}


read_config() {
    CONFIG="$MY_HOSTS_DIR/myhosts.conf"

    if [[ -e "$CONFIG" ]]; then
        # shellcheck source=/dev/null
        source "$CONFIG"
    fi
}


log() {
    # make sure log statements go to stderr
    # so normal echoes can be used for returns etc.
    echo "$(date '+%F %T') $*" >&2
}


main() {
    if [[ $# -eq 0 ]]; then
        log "No arguments supplied"
        usage
        exit 1
    fi

    if [[ ! -e "$MY_HOSTS_DIR" ]]; then
        mkdir -p "$MY_HOSTS_DIR"
    fi

    read_config

    while [[ $# -gt 0 ]]; do
        case "$1" in
            # override variables
            # which can also be done in config file
            -wd|--work-days)
                WORK_DAYS="$2"
                shift
                ;;
            -ws|--work-start)
                WORK_START="$2"
                shift
                ;;
            -we|--work-end)
                WORK_END="$2"
                shift
                ;;
            -ue|--update-extensions)
                UPDATE_EXTENSIONS="$2"
                shift
                ;;
            -uf|--update-flags)
                UPDATE_FLAGS="$2"
                shift
                ;;
            -wex|--work-extensions)
                UPDATE_EXTENSIONS="$2"
                shift
                ;;
            -wu|--work-flags)
                UPDATE_FLAGS="$2"
                shift
                ;;
            -rn|--restart-network)
                RESTART_NETWORK=true
                ;;
            # tasks
            -h|--help)
                usage
                exit 0
                ;;
            -a|--auto)
                my_hosts_file="$(determine_hosts_file)"
                ;;
            -w|--work)
                my_hosts_file="$MY_HOSTS_DIR/hosts.work"
                ;;
            -d|--default)
                my_hosts_file="$MY_HOSTS_DIR/hosts.main"
                ;;
            -g|--get)
                get_hosts=true
                ;;
            -s|--setup)
                run_setup
                exit 0
                ;;
            -u|--update)
                update_repo "$SB_HOSTS_DIR"
                set_up_venv
                generate_work_hosts_file        
                generate_main_hosts_file
                exit 0
                ;;
        esac
        shift
    done

    if [[ -z "${my_hosts_file+x}" ]]; then
        log "no hosts file specified, please run with either --default or --work to specifiy file or with --auto to use timer."
        exit 1
    fi

    if [[ ! -e "$my_hosts_file" && "$get_hosts" = false ]]; then
        log "hosts file does not exist: $my_hosts_file - run with --get|-g to recreate specified hosts file, or run with --setup|-s to clone repo re-generate all files"
        exit 1
    elif [[ "$get_hosts" = true ]]; then
        cd "$SB_HOSTS_DIR" || exit 1
        generate_hosts_files "$my_hosts_file"
    fi

    STATE_FILE="$MY_HOSTS_DIR/.hosts-current"
    PREV=""
    [[ -f "$STATE_FILE" ]] && PREV=$(cat "$STATE_FILE")

    if [[ "$my_hosts_file" != "$PREV" ]]; then
        log "copying hosts file: $my_hosts_file to system hosts file: /etc/hosts"
        sudo cp -v "$my_hosts_file" /etc/hosts --backup --suffix=.bak

        if [[ "$RESTART_NETWORK" = true ]]; then
            log "restarting network manager to flush dns cache"
            sudo systemctl restart NetworkManager
        fi
        log "$my_hosts_file" > "$STATE_FILE"
    else
        log "hosts file already correct: ($my_hosts_file)"
    fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
